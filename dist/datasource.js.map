{"version":3,"sources":["../src/datasource.js"],"names":["_","EventStoreDatasource","instanceSettings","$q","backendSrv","templateSrv","api","namespace","databaseField","undefined","databaseParameter","jsonData","databases","selectedDatabase","name","securityToken","type","endsWith","url","grafanaURL","apiURL","q","headers","options","query","buildQueryParameters","targets","filter","t","hide","length","refId","when","data","doRequest","method","then","response","catch","error","console","log","status","message","title","replace","annotation","annotationQuery","range","datasource","enable","iconColor","rangeRaw","result","interpolated","target","mapToTextValue","callback","scope","parameter","queryParameter","map","d","i","text","value","isObject","withCredentials","datasourceRequest","scopedVars","select","selectedColumn","from","selectedTable","equalPredicate","equalPredicateValue","ts","selectedTimestamp","readOption","queryType"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class EventStoreDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    var api = 'com/ibm/event/api/v1';\n    var namespace = api + '/grafana';\n    var databaseField = '?databaseName=';\n\n    /**\n     * Capture the settings information from the Data Source panel\n     */\n    if (instanceSettings !== undefined) {\n      this.databaseParameter = databaseField + instanceSettings.jsonData.databases[instanceSettings.jsonData.selectedDatabase].name;\n      this.securityToken = instanceSettings.jsonData.securityToken;\n      this.type = instanceSettings.type;\n      if (_.endsWith(instanceSettings.jsonData.url, '/')) {\n        this.grafanaURL = instanceSettings.jsonData.url + namespace;\n        this.apiURL = instanceSettings.jsonData.url + api;\n      } else {\n        this.grafanaURL = instanceSettings.jsonData.url + '/' + namespace;\n        this.apiURL = instanceSettings.jsonData.url + '/' + api;\n      }\n      this.name = instanceSettings.name;\n    }\n\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n\n    /**\n     * Supported header, including the required security token\n      */\n    this.headers = {\n      'Authorization': instanceSettings.jsonData.securityToken,\n      'cache-control': 'no-cache',\n      'content-type': 'application/json'\n    };\n  }\n\n  /**\n   * Send a query to the REST Server\n   */\n  query(options) {\n    var query = this.buildQueryParameters(options);\n    query.targets = query.targets.filter(t => !t.hide);\n\n    if (query.targets.length <= 0 || query.targets[0].refId === undefined) {\n      return this.q.when({\n        data: []\n      });\n    }\n\n    return this.doRequest({\n      url: this.grafanaURL + '/query' + this.databaseParameter,\n      data: query,\n      method: 'POST'\n    })\n    .then(function (response) {\n      return response.data;\n    })\n    .catch(function (error) {\n      console.log(error);\n    });\n  }\n\n  /**\n   * Test Connection\n   */\n  testDatasource() {\n    return this.doRequest({\n      url: this.grafanaURL + '/',\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        return {\n          status: \"success\",\n          message: \"IBM Db2 Event Store Data source is working\",\n          title: \"Success\"\n        };\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.doRequest({\n      url: this.url + '/annotations',\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      return result.data;\n    });\n  }\n\n  metricFindQuery(query) {\n    var interpolated = {\n      target: this.templateSrv.replace(query, null, 'regex')\n    };\n\n    return this.doRequest({\n      url: this.url + '/search',\n      data: interpolated,\n      method: 'POST',\n    }).then(this.mapToTextValue);\n  }\n\n  /**\n   * Common API to get all information from IBM Db2 Event Store\n   */\n  metricAPIQuery(api, callback, scope, parameter) {\n    var queryParameter = this.databaseParameter;\n    if (parameter !== undefined) {\n      queryParameter += '&' + parameter;\n    }\n    return this.doRequest({\n      url: this.apiURL + api + queryParameter,\n      method: 'GET',\n    })\n    .then(function (response) {\n      callback(response.data.data, scope);\n    })\n    .catch(function (error) {\n      console.log(error);\n    });\n  }\n\n  mapToTextValue(result) {\n    return _.map(result.data, (d, i) => {\n      if (d && d.text && d.value) {\n        return {\n          text: d.text,\n          value: d.value\n        };\n      } else if (_.isObject(d)) {\n        return {\n          text: d,\n          value: i\n        };\n      }\n      return {\n        text: d,\n        value: d\n      };\n    });\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  buildQueryParameters(options) {\n\n    var targets = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\n        refId: target.refId,\n        select: target.selectedColumn,\n        from: target.selectedTable,\n        selectedTable: target.selectedTable,\n        equalPredicate: target.equalPredicate,\n        equalPredicateValue: target.equalPredicateValue,\n        ts: target.selectedTimestamp,\n        readOption: target.readOption,\n        queryType: target.type || 'timeseries'\n      };\n    });\n\n    options.targets = targets;\n\n    return options;\n  }\n}\n"]}